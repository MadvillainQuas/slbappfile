name: Update folders.json

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'data_*/**'
      - 'data/**'
      - 'adult/**'
      - 'Adult/**'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate folders.json
        shell: bash
        run: |
          echo "Scanning for data folders..."
          echo "Current directory: $(pwd)"
          echo "Directory listing:"
          ls -la
          echo ""
          echo "Adult directory contents (if exists):"
          ls -la adult/ 2>/dev/null || echo "No adult directory"
          echo ""

          # Find all data_* folders
          echo "Finding all data_* folders..."
          find . -maxdepth 3 -type d -name "data_*" -print
          echo ""

          # Start JSON
          echo '{"folders":[' > folders.json

          first=true

          # Use while loop with process substitution for safer handling
          while IFS= read -r dir; do
            [ -z "$dir" ] && continue

            folder_name=$(basename "$dir")
            dir_path="${dir#./}"

            echo "Checking: $dir_path (folder: $folder_name)"

            # Check if folder has stints.csv (valid data folder)
            if [ ! -f "$dir/stints.csv" ]; then
              echo "  -> No stints.csv, skipping"
              continue
            fi

            echo "  -> Has stints.csv"

            timestamp=""
            code_part=""

            # Try new ISO-like format: data_YYYY-MM-DDTHH-MM_CODE
            if [[ $folder_name =~ ^data_([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}-[0-9]{2})_(.+)$ ]]; then
              timestamp="${BASH_REMATCH[1]}"
              code_part="${BASH_REMATCH[2]}"
              echo "  -> Matched new format: timestamp=$timestamp, code=$code_part"
            # Try old format: data_YYYYMMDD_HHMM_CODE
            elif [[ $folder_name =~ ^data_([0-9]{8})_([0-9]{4})_(.+)$ ]]; then
              timestamp="${BASH_REMATCH[1]}_${BASH_REMATCH[2]}"
              code_part="${BASH_REMATCH[3]}"
              echo "  -> Matched old format: timestamp=$timestamp, code=$code_part"
            else
              echo "  -> No pattern match for: $folder_name"
            fi

            if [ -n "$timestamp" ] && [ -n "$code_part" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                echo ',' >> folders.json
              fi
              echo "  {\"path\":\"$dir_path\",\"folder_name\":\"$folder_name\",\"timestamp\":\"$timestamp\",\"competition_code\":\"$code_part\"}" >> folders.json
              echo "  -> Added to manifest"
            fi
          done < <(find . -maxdepth 3 -type d -name "data_*" | sort -r)

          # Check for legacy 'data' folder
          if [ -d "./data" ] && [ -f "./data/stints.csv" ]; then
            if [ "$first" = true ]; then
              first=false
            else
              echo ',' >> folders.json
            fi
            echo '  {"path":"data","folder_name":"data","timestamp":"legacy","competition_code":"DEFAULT"}' >> folders.json
            echo "Found: legacy data folder"
          fi

          echo '' >> folders.json
          echo ']}' >> folders.json

          echo ""
          echo "========== Generated folders.json =========="
          cat folders.json
          echo "============================================="

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add folders.json
          git diff --staged --quiet || git commit -m "Auto-update folders.json"
          git push
